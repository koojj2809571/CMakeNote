进入**第二阶段：变量与逻辑控制**。这一阶段的目标是让你的 `CMakeLists.txt` 具备“思考”能力，能够根据不同的系统环境、用户需求自动调整编译策略。

这一阶段主要分为三个核心模块：**变量管理**、**逻辑判断**、**用户交互开关**。

---

### 1. 变量的定义与操作 (Variables)

在 CMake 中，变量是构建脚本的基础。

#### 1.1 普通变量 (`set`)

这是最基础的变量定义。

CMake

```
# 定义变量
set(MY_SOURCES main.cpp utils.cpp)

# 使用变量（必须加 ${}）
add_executable(MyApp ${MY_SOURCES})

# 追加变量内容
list(APPEND MY_SOURCES extra.cpp)
```

#### 1.2 环境变量 (`$ENV{...}`)

有时你需要读取系统路径（如 `JAVA_HOME` 或 `PATH`）。

CMake

```
if(DEFINED ENV{JAVA_HOME})
    message(STATUS "找到 Java 路径: $ENV{JAVA_HOME}")
endif()
```

---

### 2. 逻辑判断 (Flow Control)

CMake 使用 `if()`、`else()`、`endif()` 来处理逻辑。最常用的场景是**跨平台处理**。

#### 2.1 操作系统判断

CMake

```
if(WIN32)
    message(STATUS "正在 Windows 下构建...")
    # 这里写 Windows 专用的库链接逻辑
elseif(APPLE)
    message(STATUS "正在 macOS 下构建...")
elseif(UNIX)
    message(STATUS "正在 Linux 下构建...")
endif()
```

#### 2.2 常见的判断条件

- `if(TARGET target_name)`：检查某个目标是否存在。
    
- `if(EXISTS path)`：检查文件或文件夹是否存在。
    
- `if(MSVC)`：判断是否使用微软的编译器。
    

---

### 3. 用户交互开关 (Option & Cache Variables)

这是让你的构建脚本变得“高级”的关键：**允许用户在命令行通过 `-D` 参数来控制编译逻辑。**

#### 3.1 `option` (布尔开关)

`option` 提供了一个开关（默认为 ON 或 OFF）。

CMake

```
# 定义一个名为 USE_MY_MATH 的开关，默认为 ON
option(USE_MY_MATH "是否使用我们自定义的数学库" ON)

if(USE_MY_MATH)
    add_subdirectory(my_math)
    target_link_libraries(${PROJECT_NAME} PRIVATE MyMathLib)
    # 还可以给 C++ 代码传递一个宏定义
    target_compile_definitions(${PROJECT_NAME} PRIVATE USE_MATH_LIBRARY)
else()
    message(STATUS "跳过自定义数学库，使用系统自带库")
endif()
```

#### 3.2 在命令行使用

用户可以这样修改开关：

Bash

```
# 关闭开关
cmake -S . -B build -DUSE_MY_MATH=OFF
```

---

### 4. 实战案例：根据开关决定是否启用代码功能

我们将结合第一阶段的结构，尝试一个带“条件编译”的项目。

**项目结构：**

Plaintext

```
~/package/
├── CMakeLists.txt
├── main.cpp
```

**`main.cpp`**：

C++

```
#include <iostream>

int main() {
#ifdef ENABLE_DEBUG_PRINT
    std::cout << "DEBUG 模式已开启: 打印详细日志..." << std::endl;
#endif
    std::cout << "程序正常运行" << std::endl;
    return 0;
}
```

**`CMakeLists.txt`**：

CMake

```
cmake_minimum_required(VERSION 3.13)
project(LogicStudy LANGUAGES CXX)

# 定义一个开关
option(ENABLE_DEBUG "是否开启调试日志" OFF)

add_executable(MyApp main.cpp)

# 如果开启，则给 C++ 代码发送一个宏
if(ENABLE_DEBUG)
    target_compile_definitions(MyApp PRIVATE ENABLE_DEBUG_PRINT)
endif()
```

---

### 5. 阶段小结

**你应该掌握的操作：**

1. 知道如何用 `set` 定义变量，以及 `${}` 提取变量。
    
2. 能写出 `if(WIN32)` 这种简单的平台判断。
    
3. 知道如何用 `option` 创建开关，并通过命令行 `-D` 参数修改它。
    

练习建议：

尝试在你的 CMakeLists.txt 中添加一个 option，控制是否打印出 ${PROJECT_SOURCE_DIR}。然后分别在开启和关闭状态下运行 cmake -S . -B build。

**你想深入了解如何在多个子目录 (`add_subdirectory`) 之间传递变量，还是直接进入“第三阶段：模块化管理”？**